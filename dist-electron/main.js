"use strict";const a=require("electron"),M=require("path"),W=require("url"),G=require("http"),E=require("crypto"),Y=require("electron-store"),B=require("ws");var I=typeof document<"u"?document.currentScript:null;const _=new Y({name:"swanson-config",encryptionKey:"swanson-secure-storage-key",defaults:{auth:{},settings:{theme:"light"},server:{url:"http://localhost:18790",token:"swanson-dev-token"},threadsCache:[],plansCache:[]}});function z(){return _.get("auth")}function Q(e){_.set("auth",e)}function X(){_.set("auth",{})}function Z(){return _.get("settings")}function ee(e,t){_.set(`settings.${e}`,t)}function te(e){return _.get(`settings.${e}`)}function O(){return _.get("server",{url:"http://localhost:18790",token:"swanson-dev-token"})}function ne(e){const t=O();_.set("server",{...t,...e})}const L=4200,se="/sso/index.html",oe="776631454856-nbpd33ph7gpeeve0p1m80ibi2s5bmlj7.apps.googleusercontent.com",re="https://dev.api.reports.teachupbeat.net/auth/google/callback";function ae(){const e=E.randomUUID().replace(/-/g,""),t=Buffer.from(JSON.stringify({nonce:e,redirect:`http://localhost:${L}`,timestamp:Date.now()})).toString("base64");return`https://accounts.google.com/o/oauth2/v2/auth?${new URLSearchParams({client_id:oe,redirect_uri:re,response_type:"code",scope:"email openid profile",access_type:"offline",prompt:"select_account",state:t}).toString()}`}let T=null;function $(e){var t;try{const n=e.split(".");if(n.length!==3)return null;let s=n[1].replace(/-/g,"+").replace(/_/g,"/");for(;s.length%4;)s+="=";const o=Buffer.from(s,"base64").toString("utf-8"),r=JSON.parse(o);let l=r.email||((t=r["cognito:username"])!=null&&t.includes("@")?r["cognito:username"]:null)||r.preferred_username;return l&&(l=l.replace(/^google_/,"")),{email:l,name:r.given_name&&r.family_name?`${r.given_name} ${r.family_name}`:r.given_name||r.nickname||r.name||null,sub:r.sub}}catch(n){return console.error("Failed to decode JWT:",n),null}}function ce(){return new Promise((e,t)=>{T&&T.close(),T=G.createServer((n,s)=>{const o=new W.URL(n.url||"",`http://localhost:${L}`);if(o.pathname===se||o.pathname==="/sso/"||o.pathname==="/"){const r=o.searchParams.get("id_token"),l=o.searchParams.get("access_token")||o.searchParams.get("token")||r,w=o.searchParams.get("refresh_token")||o.searchParams.get("refresh");let c=o.searchParams.get("email")||o.searchParams.get("user_email"),y=o.searchParams.get("name")||o.searchParams.get("user_name")||o.searchParams.get("display_name");if(!c){if(r){const p=$(r);p&&(c=p.email||null,y=y||p.name||null)}if(!c&&l&&l!==r){const p=$(l);p&&(c=p.email||null,y=y||p.name||null)}}if(l){const p={accessToken:l,refreshToken:w||void 0,user:c?{email:c,name:y||c}:void 0};Q({accessToken:p.accessToken,refreshToken:p.refreshToken,user:p.user}),s.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),s.end(`<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Authentication Successful</title>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
  background: #f9fafb;
}
.container {
  text-align: center;
  padding: 2rem;
}
.success {
  color: #059669;
  font-size: 1.5rem;
  margin-bottom: 1rem;
}
.message {
  color: #6b7280;
}
</style>
</head>
<body>
<div class="container">
  <div class="success">&#10003; Authentication Successful</div>
  <p class="message">You can close this window and return to Swanson.</p>
</div>
<script>
setTimeout(function() { window.close(); }, 2000);
<\/script>
</body>
</html>`),U(),e(p)}else s.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),s.end(`<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Processing Authentication...</title>
</head>
<body>
<p>Processing authentication...</p>
<script>
if (window.location.hash) {
  var hash = window.location.hash.substring(1);
  window.location.href = window.location.pathname + '?' + hash;
} else {
  document.body.innerHTML = '<p>Authentication failed. Please try again.</p>';
}
<\/script>
</body>
</html>`)}else s.writeHead(404),s.end("Not Found")}),T.on("error",n=>{n.code!=="EPIPE"&&t(n)}),T.listen(L,"127.0.0.1"),setTimeout(()=>{T&&(U(),t(new Error("Authentication timed out")))},5*60*1e3)})}function U(){T&&(T.close(),T=null)}async function ie(e){const t=ce(),n=ae();await a.shell.openExternal(n);const s=await t;return e.webContents.send("auth-success",s),s}function le(){X(),U()}function J(){const e=z();return{isAuthenticated:!!(e!=null&&e.accessToken),user:e==null?void 0:e.user}}let k=null,v="disconnected",d=null,u=null,i=null,A=null,R=0,C=null,S=!1,f=null,g="";const q=10,ue=1e3,P=new Map;let b="main";function de(){if(!k)return null;try{const e=new URL(k.serverUrl);return e.protocol=e.protocol==="https:"?"wss:":"ws:",e.pathname="/ws",e.toString()}catch{return null}}function N(e){d&&d.readyState===B.OPEN&&d.send(JSON.stringify(e))}function m(e,t){if(!C||C.isDestroyed())return;const n={type:e,sessionId:b,payload:t,timestamp:new Date().toISOString()};C.webContents.send("openclaw-message",n)}function fe(e){let t;try{t=JSON.parse(e.toString())}catch{return}const n=t.type;if(n==="res"&&typeof t.id=="string"){const s=P.get(t.id);if(s){clearTimeout(s.timer),P.delete(t.id),t.ok?s.resolve(t.payload):s.reject(new Error(JSON.stringify(t.error||"Unknown error")));return}if(t.id===f&&t.ok){const o=t.payload;if((o==null?void 0:o.status)==="ok"&&S){const r=o.result,l=r==null?void 0:r.payloads;if(l!=null&&l.length){const w=l.map(c=>c.text||"").join(`
`);w&&!g&&(g=w)}m("chat",{content:g,delta:!1,done:!0,messageId:f}),S=!1,f=null,g=""}}return}if(n==="event"){const s=t.event,o=t.payload;if(s==="connect.challenge"){j();return}if(s==="agent"&&o){me(o);return}if(s==="session.start"||s==="session.end")return}}function j(e){k&&N({type:"req",id:E.randomUUID(),method:"connect",params:{minProtocol:3,maxProtocol:3,client:{id:"cli",version:"1.0.0",platform:process.platform,mode:"cli"},role:"operator",scopes:["operator.read","operator.write"],auth:{token:k.token}}})}function me(e){const t=e.stream,n=e.data,s=n==null?void 0:n.delta,o=n==null?void 0:n.phase;if(t==="lifecycle"){if(o==="start")return;if(o==="end"||o==="error"){if(S&&f&&(m("chat",{content:g,delta:!1,done:!0,messageId:f}),S=!1,f=null,g=""),o==="error"){const r=(n==null?void 0:n.error)||"Agent run failed";m("error",{code:"AGENT_ERROR",message:r})}return}}if(t==="assistant"&&s&&f){g+=s,m("chat",{content:s,delta:!0,done:!1,messageId:f});return}}function F(){S&&f&&m("chat",{content:g,delta:!1,done:!0,messageId:f}),S=!1,f=null,g=""}function pe(e,t,n){k={serverUrl:e,token:t,userEmail:n},b=`swanson-${n.replace(/[^a-zA-Z0-9]/g,"-")}`}async function V(){if(!k)return{success:!1,error:"Client not configured. Set server URL and token first."};const e=de();return e?(i&&(clearTimeout(i),i=null),u&&(u.removeAllListeners(),u.on("error",()=>{}),u.terminate(),u=null),d&&(d.removeAllListeners(),d.on("error",()=>{}),d.close(),d=null),new Promise(t=>{const n=new B(e);u=n;let s=!1,o=!1;const r=w=>{o||(o=!0,t(w))},l=w=>{let c;try{c=JSON.parse(w.toString())}catch{return}if(c.type==="event"&&c.event==="connect.challenge"){j(c.payload);return}if(c.type==="res"&&c.ok===!0){const y=c.payload;if((y==null?void 0:y.type)==="hello-ok"){s=!0,v="connected",R=0,i&&(clearTimeout(i),i=null),n.removeListener("message",l),n.on("message",fe),r({success:!0});return}}if(c.type==="res"&&c.ok===!1){i&&(clearTimeout(i),i=null),n.close(),d=null,u=null,v="disconnected";const y=JSON.stringify(c.error||"Authentication failed");r({success:!1,error:y})}};n.on("message",l),n.on("open",()=>{d=n,u=null}),n.on("close",()=>{s?(v="disconnected",m("status",{state:"disconnected",message:"Connection closed"}),F(),C&&D()):(i&&(clearTimeout(i),i=null),u=null,v="disconnected",r({success:!1,error:"Connection closed before handshake completed"}))}),n.on("error",w=>{s?m("error",{code:"WS_ERROR",message:w.message}):(i&&(clearTimeout(i),i=null),u=null,v="disconnected",r({success:!1,error:`WebSocket error: ${w.message}`}))}),i=setTimeout(()=>{s||(n.removeAllListeners(),n.on("error",()=>{}),n.close(),d=null,u=null,i=null,v="disconnected",r({success:!1,error:"Connection handshake timed out"}))},1e4)})):{success:!1,error:"Invalid server URL"}}function H(){F(),i&&(clearTimeout(i),i=null),u&&(u.removeAllListeners(),u.on("error",()=>{}),u.terminate(),u=null),d&&(d.removeAllListeners(),d.on("error",()=>{}),d.close(),d=null),A&&(clearTimeout(A),A=null),v="disconnected",R=0;for(const[e,t]of P)clearTimeout(t.timer),t.reject(new Error("Disconnected"));P.clear()}function he(){return v}function D(){if(R>=q){v="disconnected",m("status",{state:"disconnected",message:"Max reconnection attempts reached"});return}v="reconnecting";const e=Math.min(ue*Math.pow(2,R),3e4);R++,m("status",{state:"reconnecting",message:`Reconnecting in ${Math.round(e/1e3)}s (attempt ${R}/${q})`}),A=setTimeout(async()=>{(await V()).success?m("status",{state:"connected",message:"Reconnected"}):D()},e)}async function ge(e,t,n){if(C=e,!k||v!=="connected"){m("error",{code:"NOT_CONNECTED",message:"Not connected to OpenClaw server"});return}const s=E.randomUUID();f=s,g="",S=!0,m("chat",{content:"",delta:!1,done:!1,messageId:s});try{const o=E.randomUUID();N({type:"req",id:s,method:"agent",params:{sessionKey:n||b,message:t,idempotencyKey:o}})}catch(o){m("error",{code:"REQUEST_ERROR",message:o.message}),S=!1,f=null,g="",D()}}function we(){S&&(N({type:"req",id:E.randomUUID(),method:"agent.stop",params:{sessionKey:b}}),S=!1,f=null,g="")}function ye(){return S}const ve=W.fileURLToPath(typeof document>"u"?require("url").pathToFileURL(__filename).href:I&&I.tagName.toUpperCase()==="SCRIPT"&&I.src||new URL("main.js",document.baseURI).href),x=M.dirname(ve);let h=null;function K(){h=new a.BrowserWindow({width:1200,height:800,minWidth:800,minHeight:600,titleBarStyle:"hiddenInset",trafficLightPosition:{x:15,y:15},webPreferences:{preload:M.join(x,"preload.js"),contextIsolation:!0,nodeIntegration:!1}}),process.env.VITE_DEV_SERVER_URL?(h.loadURL(process.env.VITE_DEV_SERVER_URL),h.webContents.openDevTools()):h.loadFile(M.join(x,"../dist/index.html")),h.on("closed",()=>{h=null})}a.app.whenReady().then(K);a.app.on("window-all-closed",()=>{process.platform!=="darwin"&&a.app.quit()});a.app.on("activate",()=>{a.BrowserWindow.getAllWindows().length===0&&K()});a.ipcMain.handle("get-app-version",()=>a.app.getVersion());a.ipcMain.handle("auth:login",async()=>{if(!h)throw new Error("No main window");try{return{success:!0,user:(await ie(h)).user}}catch(e){return{success:!1,error:e.message}}});a.ipcMain.handle("auth:logout",()=>(le(),{success:!0}));a.ipcMain.handle("auth:get-state",()=>J());a.ipcMain.handle("settings:get",(e,t)=>t?te(t):Z());a.ipcMain.handle("settings:set",(e,t,n)=>(ee(t,n),{success:!0}));a.ipcMain.handle("openclaw:connect",async()=>{var o;const e=O(),t=J(),n=((o=t==null?void 0:t.user)==null?void 0:o.email)||"unknown";pe(e.url,e.token,n);const s=await V();return s.success&&h&&h.webContents.send("openclaw-message",{type:"status",sessionId:"",payload:{state:"connected",message:"Connected to OpenClaw server"},timestamp:new Date().toISOString()}),s});a.ipcMain.handle("openclaw:send",async(e,t,n)=>{if(!h)throw new Error("No main window");return await ge(h,t,n),{success:!0}});a.ipcMain.handle("openclaw:stop",()=>(we(),{success:!0}));a.ipcMain.handle("openclaw:disconnect",()=>(H(),{success:!0}));a.ipcMain.handle("openclaw:status",()=>({state:he()}));a.ipcMain.handle("openclaw:is-active",()=>ye());a.ipcMain.handle("openclaw:set-server",(e,t,n)=>(ne({url:t,token:n}),{success:!0}));a.ipcMain.handle("openclaw:get-server",()=>O());a.app.on("before-quit",()=>{U(),H()});
